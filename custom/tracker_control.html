<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <link   rel="stylesheet" href="midas.css">
    <link id="favicon" rel="shortcut icon" type="image/png" href="favicon.png" />
    <script src="controls.js"></script>
    <script src="midas.js"></script>
    <script src="mhttpd.js"></script>
    <script src="filesrw.js"></script>
    <script src="odbbrowser.js"></script>
    
    <link   rel="stylesheet" href="mu2edaq.css">
    
    <!--
         <link   rel="stylesheet" href="tracker.css">
    -->    

    <script srs="global_variables.js"></script>
    <script src="mu2edaq.js"></script>
    <script src="tracker_commands.js"></script>
    
    <title>TrackerControl</title>
    
    <script>
    //-----------------------------------------------------------------------------
    function loadPanelControlTable() {
      const table      = document.getElementById('panel_commands');
      
      table.innerHTML  = '';
      
      let thead    = document.createElement('thead');
      let tr       = document.createElement('tr');
      let td       = document.createElement('td');

      td.innerHTML = `<div class="mtableheader" colspan=2> Panel MN${g_mnid.toString().padStart(3,'0')} controls </div>`;
      td.colspan   = 4;

      tr.appendChild(td);
      thead.appendChild(tr);
      table.appendChild(thead);

      // now - the table body
      
      const tbody  = document.createElement('tbody');

      tr = document.createElement('tr');
      td = document.createElement('td');
      td.colspan = 2;
      td.innerHTML = `
        <div class="dropup">
          <input type=button class="dropbtn" value='read'>
          <div class="dropup-content">
            <div onClick='dtc_load_parameters_control_roc_read()'> Load Parameters </div>
            <div onClick='dtc_command("dtc_control_roc_read")'   > Run             </div>
          </div>
        </div>

        <div class="dropup">
          <input type=button class="dropbtn" value='pulser_on'>
          <div class="dropup-content">
            <div onClick='dtc_load_parameters_control_roc_pulser_on()'> Load Parameters </div>
            <div onClick='dtc_command("dtc_control_roc_pulser_on")'   > Run             </div>
          </div>
        </div>

        <div class="dropup">
          <input type=button class="dropbtn" value='pulser_off'>
          <div class="dropup-content">
            <div onClick='dtc_load_parameters_control_roc_pulser_off()'> Load Parameters </div>
            <div onClick='dtc_command("dtc_control_roc_pulser_off")'   > Run             </div>
          </div>
        </div>

        <div class="dropup">
          <input type=button class="dropbtn" value='rates'>
          <div class="dropup-content">
            <div onClick='dtc_load_parameters_control_roc_rates()'> Load Parameters </div>
            <div onClick='dtc_command("dtc_control_roc_rates")'   > Run             </div>
          </div>
        </div>
      `;

      tr.appendChild(td);
      tbody.appendChild(tr);
      
      // second row : non-dropbtn commands      

      let tr2 = document.createElement('tr');
      let td2 = document.createElement('td');
      //
      let stn = g_station.toString().padStart(2,'0');
      let pln = g_plane.toString().padStart(2,'0');
      let pnl = g_panel.toString().padStart(2,'0');

      let cmdb = new Command_B('load_parameters','load_parameters',mu2e_odb_load_table,'cmd_params' , trk_panel_config_path);
      let btn  = mu2e_make_exec_button_B(cmdb);
      td2.appendChild(btn);

      // trk_panel_command identifies the panel in parameters and sets for execution
      
      cmdb = new Command_B('load_thresholds'   ,'load_thresholds'   , trk_panel_command_set_odb_B, 'cmd_params' ,trk_cmd_path);
      btn = make_set_odb_button(cmdb);
      td2.appendChild(btn);

      cmdb = new Command_B('load_channel_map'  ,'load_channel_map', trk_panel_command_set_odb_B, 'cmd_params' ,trk_cmd_path);
      btn = make_set_odb_button(cmdb);
      td2.appendChild(btn);

      cmdb = new Command_B('set_thresholds'    ,'set_thresholds'    , trk_panel_command_set_odb_B, 'cmd_params' ,trk_cmd_path);
      btn = make_set_odb_button(cmdb);
      td2.appendChild(btn);

      cmdb = new Command_B('measure_thresholds','measure_thresholds',trk_panel_command_set_odb_B,'cmd_params' ,trk_cmd_path);
      btn = make_load_table_button(cmdb);
      td2.appendChild(btn);

      cmdb = new Command_B('find_alignment','find_alignment',trk_panel_command_set_odb_B,'cmd_params' ,trk_cmd_path);
      btn = make_load_table_button(cmdb);
      td2.appendChild(btn);
      //
      //      cmda = new Command_A('print_status'      ,'panel_print_status'      ,trk_panel_command_set_odb,'cmd_params' ,`/Mu2e/Commands/Tracker`);
      //      btn = make_load_table_button(cmda);
      //      td2.appendChild(btn);
      //
      tr2.appendChild(td2);
      tbody.appendChild(tr2);
      table.appendChild(tbody);

    }

//-----------------------------------------------------------------------------
    async function trk_update_panel_id(event,panel_id) {
      await trk_choose_panel_id(event, panel_id);
      loadPanelControlTable();
    }
    
//-----------------------------------------------------------------------------
    function loadStationControlTable() {

      // reset  plane and panel IDs
      
      g_plane        = 0;
      g_panel        = 0;
      
      const plane1   = 2*g_station;
      const plane2   = 2*g_station+1;

      const table     = document.getElementById('station_commands');
      table.innerHTML = '';
      
      let thead      = document.createElement('thead');

      let tr = document.createElement('tr');
      // tr.colSpan = 9;
      tr.innerHTML = `<td colspan=9> <div class="mtableheader">Station ${g_station} controls</div></td>`;

      thead.appendChild(tr);


      tr = document.createElement('tr');
      let td = document.createElement('td');
      td.colSpan = 2;

      let btn = document.createElement('input');
      btn.type = 'button';
      btn.value = 'load_parameters';
      btn.onclick = function() { trk_station_load_parameters(g_station) ; } ;

      td.appendChild(btn);

      // all station-level commands should set g_station in the command parameter record
      // mu2e_command_set_odb takes Command_B as input
      let cmd_b = new Command_B('init readout','init_readout',mu2e_command_set_odb_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      let btn_b = mu2e_make_dropup_button_B(cmd_b);
      td.appendChild(btn_b);

      cmd_b = new Command_B('find_alignment','find_alignment',trk_cmd_station_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);

      cmd_b = new Command_B('load thresholds','load_thresholds',trk_cmd_station_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);

      cmd_b = new Command_B('set_thresholds','set_thresholds',trk_cmd_station_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);

      cmd_b = new Command_B('read','read',trk_cmd_station_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);

      cmd_b = new Command_B('print status','print_status',trk_cmd_station_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);

      // don't need to specify the stations
//       cmd_b = new Command_B('reset output','reset_output',mu2e_command_set_odb_B,'cmd_params',trk_cmd_path,"trkdtc.log");
//       btn_b = mu2e_make_exec_button_B(cmd_b);
//       td.appendChild(btn_b);

      // 
      cmd_b = new Command_B('reset LV','reset_lv',trk_cmd_station_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);

      tr.appendChild(td);
      thead.appendChild(tr);

      table.appendChild(thead);

      let tbody = document.createElement('tbody');
      tbody.innerHTML = `
        <tr>
          <td>
            <div class="tab">
              <button class="trk_plane_tab" id="trk_plane_0" onclick="trk_choose_plane_id(event,'${plane1}')">zplane:${plane1}</button>
            </div>
          </td>
          <td colspan> <div class="tab" id="trk_panel_tabs_0"></div></td>
        </tr>
        
        <tr>
          <td>
            <div class="tab">
              <button class="trk_plane_tab" id="trk_plane_1" onclick="trk_choose_plane_id(event,'${plane2}')">zplane:${plane2}</button>
            </div>
          </td>
          <td colspan> <div class="tab" id="trk_panel_tabs_1"></div></td>
        </tr>
      `;

      table.appendChild(tbody);

//-----------------------------------------------------------------------------
// create panel buttons
//-----------------------------------------------------------------------------

      const station_path  = `/Mu2e/ActiveRunConfiguration/Tracker/Station_${g_station.toString().padStart(2,'0')}`;

      for (let pln=0; pln<2; pln++) {
        const div_panel_tabs = document.getElementById("trk_panel_tabs_"+pln.toString());
        const paths = [];
        for (let ip=0; ip<6; ip++) {
// find out the panel MNID
          const panel_odb_path = station_path+'/Plane_'+pln.toString().padStart(2,'0')+'/Panel_'+ip.toString().padStart(2,'0');
          const mnid_path      = panel_odb_path+`/Name`;
          paths.push(mnid_path);
        }
        
        mjsonrpc_db_get_values(paths).then( function (rpc) {
          // mnid is an integer
          for (let ip=0;ip<6; ip++) {
            const panel_name = rpc.result.data[ip];
            const mnid       = parseInt(panel_name.substring(2));
            // choosing the panel ID should also redraw the panel control table
            div_panel_tabs.innerHTML += `<button class="trk_panel_tab" id='${panel_name}' onclick="trk_update_panel_id(event,'${panel_name}')">${panel_name}</button>`
          };
        });
      };
    }

//-----------------------------------------------------------------------------
    function trk_update_station_id(event,station_id) {
      trk_choose_station_id(event, station_id);
      loadStationControlTable();
    }
    
//-----------------------------------------------------------------------------
// main function: loadPage
//-----------------------------------------------------------------------------

    function loadPage() {
      const urlParams  = new URLSearchParams(window.location.search);
      
      g_hostname = urlParams.get('hostname') || 'none';  // 
      g_station  = urlParams.get("station" ) || "0";     // defined in trk_commands.js
      g_plane    = urlParams.get("plane"   ) || "0";
      g_panel    = urlParams.get("panel"   ) || "0";
      g_mnid     = parseInt(urlParams.get("mnid"    )) || 0;
      
      const tracker_path  = `/Mu2e/ActiveRunConfiguration/Tracker`;
      
      let title        = document.getElementById('table-title');
      title.innerHTML  = ''; //&nbsp;&nbsp;&nbsp;'+g_hostname+' DTC status page';
     
//-----------------------------------------------------------------------------
//  tracker commands table
//-----------------------------------------------------------------------------

      const tracker_cmd_table     = document.getElementById('tracker_commands');
      tracker_cmd_table.innerHTML = ``;
      let thead = document.createElement('thead');
      let tr = document.createElement('tr');
      let td = document.createElement('td');
      td.colSpan = 8;
      td.innerHTML = `<div class="mtableheader">Tracker controls</div>`;
      tr.appendChild(td);
      thead.appendChild(tr);

      tr = document.createElement('tr');
      td = document.createElement('td');
      td.colSpan = 8;

      // load tracker config table for active configuration - thus 'trk_config_path'
      let cmd_b = new Command_B('load parameters','load_parameters',mu2e_odb_load_table,'cmd_params',trk_config_path,"trkdtc.log");
      let btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);
      
      cmd_b = new Command_B('load thresholds','load_thresholds',trk_cmd_all_stations_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);
      
      cmd_b = new Command_B('find_alignment','find_alignment',trk_cmd_all_stations_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);
      
      cmd_b = new Command_B('set thresholds','set_thresholds',trk_cmd_all_stations_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);
      
      cmd_b = new Command_B('load channel map','load_channel_map',trk_cmd_all_stations_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);

      cmd_b = new Command_B('read','read',trk_cmd_all_stations_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);

      // not sure what I thought about...
      cmd_b = new Command_B('initialize','initialize',trk_cmd_all_stations_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);
      
      cmd_b = new Command_B('reset LV','reset_lv',trk_cmd_all_stations_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);
      
      cmd_b = new Command_B('reset output','reset_output',mu2e_command_set_odb_B,'cmd_params',trk_cmd_path,"trkdtc.log");
      btn_b = mu2e_make_exec_button_B(cmd_b);
      td.appendChild(btn_b);
      
      tr.appendChild(td);
      thead.appendChild(tr);
      tracker_cmd_table.appendChild(thead);
        
      let tbody = document.createElement('tbody');
      tr = document.createElement('tr');

      td = document.createElement('td');
      td.colSpan = 3;
      td.innerText = 'Zstation:';
      tr.appendChild(td);

      td = document.createElement('td');
      td.colSpan = 5;
      
      td.innerHTML = `<div class="tab" id="trk_station_tabs"> </div>`;
      tr.appendChild(td);
      tbody.appendChild(tr);
      
      tracker_cmd_table.appendChild(tbody);
      
//------------------------------------------------------------------------------
// create station tabs
//-----------------------------------------------------------------------------
      
      let first_station  = -1;
      let last_station   = -1;
      const p1 = tracker_path+`/FirstStation`;
      const p2 = tracker_path+`/LastStation`;
      mjsonrpc_db_get_values([p1, p2]).then(function (rpc) {
        first_station = parseInt(rpc.result.data[0]);
        last_station  = parseInt(rpc.result.data[1]);
        const div_station_tabs = document.getElementById("trk_station_tabs");
        for (let is=first_station; is<last_station+1; is++) {
          let iss = is.toString().padStart(2,'0');
          // div_station_tabs.innerHTML += `<button class="trk_station_tab" id='trk_station_${is}' onclick="trk_update_station_id(event,'${is}')">${iss}</button>`
          let btn = document.createElement('button');
          btn.id        = `trk_station_${is}`
          btn.className = 'trk_station_tab';
          btn.onclick   = function() { trk_update_station_id(event,is); } ;
          btn.innerHTML = iss;
          div_station_tabs.appendChild(btn);
        };
      }).catch(function(error) {
        mjsonrpc_error_alert(error);
      });
      
//-----------------------------------------------------------------------------
// create station and panel control tables
//-----------------------------------------------------------------------------

      loadStationControlTable();
      loadPanelControlTable();
      
//-----------------------------------------------------------------------------
//  end
//-----------------------------------------------------------------------------
    }
      
    document.addEventListener("DOMContentLoaded", loadPage);
    // choose_roc_id('DOMContentLoaded','roc0')
    </script>
  </head>
  
  <!--
      it seems to be convenient to have the large scale topology defined in HTML
      and use javascript to fill internal details
      P.M.: having show_facilities etc here is important
   -->
  <body class="mcss" onload="mhttpd_init('trk_control'); show_facilities(); msg_load();">
    <div id="mheader"></div>
    <div id="msidenav"></div>
    <div id="mmain">
    
      <!-- ---------------- are they needed? and the output field ----------------  -->
      
      <div class="row">
        <h2 id="table-title">Panel Controls</h2>
        
        <div class="column"> <!-- gets pushed to the left -->
          
          <table class="mtable" id="tracker_commands">  <!-- Table content is generated dynamically -->
          </table>
          
          <table class="mtable" id="station_commands">  <!-- Table content is generated dynamically -->
          </table>
          
          <table class="mtable" id="panel_commands">  <!-- Table content is generated dynamically -->
          </table>
          
          <table class="mtable" id="cmd_params">    <!-- Table content is generated dynamically -->
          </table>
        </div>
        
        <div class="column"; style="width:55%"> <!-- gets pushed to the left -->
          <!--    ------------------------- this is the output window  -->
          <table >
            <tr>
              <td id="navigationFacilitiesButtons"></td>
            </tr>
          </table>
        
          <table class="mtable" id="messageTable" ">
            <tr>
              <td class="select">
                <label for="nameFilter">Filter: </label>

                <input type="text" id="nameFilter" placeholder="Program Name" title="Please enter a program name">
              
                <select id="typeFilter" title="Please select a message type">
                  <option value="">- all -</option>
                  <option>INFO</option>
                  <option>ERROR</option>
                  <option>USER</option>
                  <option>LOG</option>
                  <option>TALK</option>
                </select>
              
                <input type="text" id="timeFilter" placeholder="Time (hh:mm:ss)" title="Please select a time to search">
                <input type="text" id="textFilter" placeholder="Search Text" title="Please enter some search text">

                <select id="timeRangeFilter" title="We will search the file from the current time into the past">
                  <option>24 h</option>
                  <option>48 h</option>
                  <option>72 h</option>
                  <option>7 d</option>
                  <option>30 d</option>
                </select>
                <button class="mbutton" id="filterBtn">Filter</button>
              
                <select id="recentsDropdown">
                  <option value="">Select a recent filter</option>
                </select>

              </td>
            </tr>

            <tr>
              <td class="select">
                <div class="mmessagebox mfont" id="messageFrame"><h1 class="mtableheader"> Messages</h1></div>
              </td>
            </tr>
          </table>
          
          <div id="loadingOverlay"
               style="  display: none;
                      position: fixed;
                      top: 0;
                      left: 0;
                      width: 100%;
                      <!--
                      height: 100%;
                      -->
                      height: 600px;
                      background-color: rgba(128, 128, 128, 0.8);
                      color: white;
                      font-size: 24px;
                      align-items: center;
                      justify-content: center;
                      z-index: 1000;">
            Searching messages... Mouse Click to stop.
          </div>
          
        </div>
        
        <div id="dlgError" class="dlgFrame">
          <div class="dlgTitlebar">Error message</div>
          <div class="dlgPanel">
            <div id="dlgErrorText">Dialog Contents</div>
            <br />
            <button class="dlgButton" onClick="dlgHide('dlgError')">Close</button>
          </div>
        </div>
        
        <script src="messages.js"></script>

      </div>
    </div>
  </body>
</html>

<!--
    emacs
    Local Variables:
    mode: web
    End:
  -->
