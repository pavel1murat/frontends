<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <link   rel="stylesheet" href="midas.css">
    <script src="controls.js"></script>
    <script src="midas.js"></script>
    <script src="mhttpd.js"></script>
    <script src="filesrw.js"></script>
    <script src="odbbrowser.js"></script>
    
    <link   rel="stylesheet" href="mu2edaq.css">
    
    <script src="global_variables.js"></script>
    <script src="mu2edaq.js">         </script>
    <script src="mu2e_mess_001.js">   </script>
    <script src="dtc_commands.js">    </script>
    
    <title>DTC</title>
    
    <script>

//-----------------------------------------------------------------------------

    function createRocCommandsTable() {
      const table     = document.getElementById('roc_commands');

      table.innerHTML = '';
      const tbody = document.createElement('tbody');
      // tbody.innerHTML = '';

      let tr = document.createElement('tr');
      tr.innerHTML = `
        <td> <div class="mtableheader"> control_ROC commands </div> </td>
        <td colspan=3></td>
      `;

      tbody.appendChild(tr);

      tr = document.createElement('tr');
      tr.innerHTML = `
        <td colspan=2>
          <div class="dropup">
            <input type=button class="dropbtn" value='read'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("read")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("read","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='digi_rw'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("digi_rw")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("digi_rw","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='pulser_on'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("pulser_on")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("pulser_on","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='pulser_off'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("pulser_off")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("pulser_off","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='rates'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("rates")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("rates","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='read_ddr'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("read_ddr")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("read_ddr","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='set_thresholds'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("set_thresholds")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("set_thresholds","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='load_thresholds'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("load_thresholds")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("load_thresholds","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='set_caldac'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("set_caldac")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("set_caldac","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='dump_settings'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("dump_settings")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("dump_settings","trkdtc.log")'            > Run             </div>
            </div>
          </div>
        </td>
        <td> <div> Register </div> </td>
        <td> <div> Value    </div> </td>
      `;
      tbody.appendChild(tr);

      tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <input type=button value='reset ROC'          onClick='dtc_command_set_odb("reset_roc"         ,"trkdtc.log")'>
          <input type=button value='read SPI'           onClick='dtc_command_set_odb("read_spi"          ,"trkdtc.log")'>
          <input type=button value='read ILP'           onClick='dtc_command_set_odb("read_ilp"          ,"trkdtc.log")'>
          <input type=button value='read mnid'          onClick='dtc_command_set_odb("read_mnid"         ,"trkdtc.log")'>
          <input type=button value='get key'            onClick='dtc_command_set_odb("get_key"           ,"trkdtc.log")'>
          <input type=button value='find alignment'     onClick='dtc_command_set_odb("find_alignment"    ,"trkdtc.log")'>
          <input type=button value='measure thresholds' onClick='dtc_command_set_odb("measure_thresholds","trkdtc.log")'>
        </td>
        <td>
          <input type=button value='write ROC register' onClick='dtc_command_set_odb("write_roc_register","trkdtc.log")'>
        </td>
        <td>
          <div class="modbvalue" data-odb-path="/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/write_roc_register/register" data-odb-editable="1" data-format="%x"></div>
        </td>
        <td>
          <div class="modbvalue" data-odb-path="/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/write_roc_register/value" data-odb-editable="1"  data-format="%x"></div>
        </td>
      `;
     
      tbody.appendChild(tr);
      
      tr = document.createElement('tr');
      tr.innerHTML = `
        <td colspan>
          <input type=button value='get design info'  onClick='dtc_command("get_roc_design_info")'>
          <div class="dropup">
            <input type=button class="dropbtn" value='find_thresholds'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("find_thresholds")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("find_thresholds","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='program_roc'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("program_roc")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("program_roc","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <input type=button value='reboot MCU'         onClick='dtc_command_set_odb("reboot_mcu","trkdtc.log")'>
          <!--
          <input type=button value='get ID'             onClick='dtc_command("get_roc_id")'>
          <input type=button value='get GIT commit'     onClick='dtc_command("get_roc_fw_git_commit")'>
          -->
        </td>
        <td><input type=button value='read &nbsp ROC register' onClick='dtc_command_set_odb("read_roc_register","trkdtc.log")'></td>
        <td>
          <div class="modbvalue" data-odb-path="/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/read_roc_register/register" data-odb-editable="1" data-format="%x"></div>
        </td>
      `;

      //      <td>
      //      <div class="modbvalue" data-odb-path="/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/read_roc_register/value" data-format="%x"></div>
      //      </td>
      
      let td  = document.createElement('td');
      let div = document.createElement('div');
      div.classList.add('modbvalue');
      div.dataset.odbPath = `/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/read_roc_register/value`;
      div.dataset.format  = '%x';
      td.appendChild(div);
      
      tr.appendChild(td);
      
      tbody.appendChild(tr);
      table.appendChild(tbody);
      
//-----------------------------------------------------------------------------
//  define active ROC tab
//----------------------------------------------------------------------------

      const ir = g_roc;
      if (ir == -1) {ir = 6};
      const roc_id = 'roc'+ir.toString();
      const active_roc_tab = document.querySelector('.roctabs#'+roc_id);
      if (active_roc_tab == null) {
        active_roc_tab = document.querySelector('.roctabs#roc6');
      }
      active_roc_tab.focus();
      active_roc_tab.className += " active";
      console.log('g_roc=',g_roc);
    }
    
//-----------------------------------------------------------------------------
// main function: createTable
// an element ID should be unique within the page
//-----------------------------------------------------------------------------

    function loadPage() {
      const urlParams = new URLSearchParams(window.location.search);
      g_hostname      = urlParams.get('hostname') || 'none';  // 
      if (g_pcie == -1) { g_pcie = parseInt(urlParams.get('pcie')) || 0; } ;
      
      document.title = 'DTC@'+g_hostname;
      let title       = document.getElementById('table-title');
      title.innerHTML = ''; //&nbsp;&nbsp;&nbsp;'+g_hostname+' DTC status page';
//-----------------------------------------------------------------------------
//  create DTC commands table
// 'dtctabs' is just a class for selecting tabs, no special properties
//-----------------------------------------------------------------------------

      const dtc_cmd_table = document.getElementById('dtc_cmd_table');
      dtc_cmd_table.innerHTML = '';
      
      let   thead = document.createElement('thead');

      let   tr = document.createElement('tr');

      let td = document.createElement('td');
      td.innerHTML = `
        <div class="mtableheader">${g_hostname} DTC Control Commands &nbsp&nbsp
          <a href="https://mu2einternalwiki.fnal.gov/wiki/Tracker_DAQ_Help">[ Help ]</a>
        </div>
      `;
      tr.appendChild(td);

      td = document.createElement('td');
      td.colSpan=3;
      
      let div = document.createElement('div');
      div.className = 'tab';
      div.innerHTML = `
        <button class='dtctabs' id='dtc0' onclick="update_dtc_id(event,'dtc0')">PCIE:0</button>
        <button class='dtctabs' id='dtc1' onclick="update_dtc_id(event,'dtc1')">PCIE:1</button>
      `;
      td.appendChild(div);
      tr.appendChild(td);

      td = document.createElement('td');
      td.colSpan = 4;
      div = document.createElement('div');
      div.className = "tab";
      div.innerHTML = `
        <button class="roctabs" id='roc0' onclick="choose_roc_id(event,'roc0')">ROC0</button>
        <button class="roctabs" id='roc1' onclick="choose_roc_id(event,'roc1')">ROC1</button>
        <button class="roctabs" id='roc2' onclick="choose_roc_id(event,'roc2')">ROC2</button>
        <button class="roctabs" id='roc3' onclick="choose_roc_id(event,'roc3')">ROC3</button>
        <button class="roctabs" id='roc4' onclick="choose_roc_id(event,'roc4')">ROC4</button>
        <button class="roctabs" id='roc5' onclick="choose_roc_id(event,'roc5')">ROC5</button>
        <button class="roctabs" id='roc6' onclick="choose_roc_id(event,'roc6')">ALL </button>
      `;
      
      td.appendChild(div);
      tr.appendChild(td);

      thead.appendChild(tr);

      let tbody = document.createElement('tbody');

      tr = document.createElement('tr');
      tr.innerHTML = `
        <td colspan=5>
          <input type=button value='load parameters'  onClick='dtc_load_parameters()'>
          <div class="dropup">
            <input type=button class="dropbtn" value='init readout'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("init_readout")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("init_readout","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <div class="dropup">
            <input type=button class="dropbtn" value='configure_ja'>
            <div class="dropup-content">
              <div onClick='dtc_load_cmd_parameters("configure_ja")'> Load Parameters </div>
              <div onClick='dtc_command_set_odb("configure_ja","trkdtc.log")'            > Run             </div>
            </div>
          </div>
          <input type=button value='print status'     onClick='dtc_command_set_odb("print_status"    ,"trkdtc.log")'>
          <input type=button value='print ROC status' onClick='dtc_command_set_odb("print_roc_status","trkdtc.log")'>
          <input type=button value='reset output'     onClick='dtc_command_set_odb("reset_output"    ,"trkdtc.log")'>
        </td>
        <td></td>
        <td> Register </td>
        <td> Value    </td>
      `;
      tbody.appendChild(tr);

      <!----------------- DTC print status, print ROC status , write reg   -->

      tr = document.createElement('tr');

      td = document.createElement('td');
      td.colSpan = 5;
      td.innerHTML = `
          <input type=button value='CFO launch run plan' onClick='cfo_command_set_odb("cfo_launch_run_plan","trkdtc.log")'>
          <input type=button value='read subevents'      onClick='dtc_command_set_odb("read_subevents"     ,"trkdtc.log")'>
          <input type=button value='soft reset'          onClick='dtc_command_set_odb("soft_reset"         ,"trkdtc.log")'>
          <input type=button value='hard reset'          onClick='dtc_command_set_odb("hard_reset"         ,"trkdtc.log")'>
      `;

      // title,name,cmd,table_name,path_func,log: output of everything trace-related goes to trace.log
      
      let cmd_b  = new Command_B('test_commandA','test_command',dtc_command_set_odb_B,'cmd_params',test_cmd_parameter_path,"trkdtc.log");
      let btn = dtc_make_exec_button_B(cmd_b);
//      btn.addEventListener('click',dtc_command_set_odb_B);
      td.appendChild(btn);
      
      tr.appendChild(td);
      td = document.createElement('td');
      td.innerHTML = `<input type=button value='write DTC register'  onClick='dtc_command_set_odb("write_register"     ,"trkdtc.log")'>`;
      tr.appendChild(td);

      td = document.createElement('td');
      td.innerHTML = `<div class="modbvalue" data-odb-path="/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/write_register/register" data-odb-editable="1" data-format="%x"></div>`;
      tr.appendChild(td);
      
      td = document.createElement('td');
      td.innerHTML = `<div class="modbvalue" data-odb-path="/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/write_register/value"    data-odb-editable="1" data-format="%x"></div>`;
      tr.appendChild(td);

      tbody.appendChild(tr);
      
      tr = document.createElement('tr');
      tr.innerHTML = `
        <td colspan=4> </td>
        <td></td>
        <td>
          <input type=button value='read &nbsp DTC register'  onClick='dtc_command_set_odb("read_register", "trkdtc.log")'>
        </td>
      `;

//      <td>
//      <div class="modbvalue" data-odb-path="/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/read_register/register" data-odb-editable="1" data-format="%x"></div>
//      </td>

      td  = document.createElement('td');
      div = document.createElement('div');
      div.classList.add('modbvalue');
      div.dataset.odbPath     = `/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/read_register/register`;
      div.dataset.odbEditable = '1';
      div.dataset.format      = '%x';
      td.appendChild(div);
      tr.appendChild(td);

      //      <td>
      //      <div class="modbvalue" data-odb-path="/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/read_register/value" data-format="%x"></div>
      //      </td>

      td  = document.createElement('td');
      div = document.createElement('div');
      div.classList.add('modbvalue');
      div.dataset.odbPath = `/Mu2e/Commands/DAQ/Nodes/${g_hostname}/DTC${g_pcie}/read_register/value`;
      div.dataset.format  = '%x';
      td.appendChild(div);

      tr.appendChild(td);

      tbody.appendChild(tr);
      
      dtc_cmd_table.appendChild(thead);
      dtc_cmd_table.appendChild(tbody);

      
//-----------------------------------------------------------------------------
//  end, define active DTC tab
//----------------------------------------------------------------------------

      const el = document.getElementById('dtc'+g_pcie.toString());
      if (el) {
          el.focus();
          el.className += " active";
        console.log('g_pcie=',g_pcie);
      }

//-----------------------------------------------------------------------------
//  create ROC commands table
//-----------------------------------------------------------------------------

      createRocCommandsTable();
    }
    
      
    document.addEventListener("DOMContentLoaded", loadPage);
    </script>
  </head>
  <!--
     it seems to be convenient to have the high-level topology defined in HTML
     and use javascript to fill internal details
       P.M.: having show_facilities etc here is important
  -->
  <body class="mcss" onload="mhttpd_init('dtc_control'); show_facilities(); msg_load();">
    <div id="mheader"></div>
    <div id="msidenav"></div>
    <div id="mmain">
    
<!-- ---------------- row 1: DTC registers - are they needed?  and the output field ----------------  -->
      
      <div class="row">
        <h2 id="table-title">DTC </h2>
        
        <div class="column"> <!-- gets pushed to the left -->
          
          <table class="mtable" id="dtc_cmd_table">  <!-- Table content is generated dynamically -->
          </table>
          
          <table class="mtable" id="roc_commands">  <!-- Table content is generated dynamically -->
          </table>
          
          <table class="mtable" id="cmd_params">    <!-- Table content is generated dynamically -->
          </table>
          
        </div>

        <div class="column"; style="width:55%"> <!-- gets pushed to the left -->
          <!--    ------------------------- this is the output window  -->
          <table >
            <tr>
              <td id="navigationFacilitiesButtons"></td>
            </tr>
          </table>
          
          <table class="mtable" id="messageTable" ">
            <tr>
              <td class="select">
                <label for="nameFilter">Filter: </label>
                
                <input type="text" id="nameFilter" placeholder="Program Name" title="Please enter a program name">
                
                <select id="typeFilter" title="Please select a message type">
                  <option value="">- all -</option>
                  <option>INFO</option>
                  <option>ERROR</option>
                  <option>USER</option>
                  <option>LOG</option>
                  <option>TALK</option>
                </select>
                
                <input type="text" id="timeFilter" placeholder="Time (hh:mm:ss)" title="Please select a time to search">
                <input type="text" id="textFilter" placeholder="Search Text" title="Please enter some search text">
                
                <select id="timeRangeFilter" title="We will search the file from the current time into the past">
                  <option>24 h</option>
                  <option>48 h</option>
                  <option>72 h</option>
                  <option>7 d</option>
                  <option>30 d</option>
                </select>
                <button class="mbutton" id="filterBtn">Filter</button>
                
                <select id="recentsDropdown">
                  <option value="">Select a recent filter</option>
                </select>
                
              </td>
            </tr>
            
            <tr>
              <td class="select">
                <div class="mmessagebox mfont" id="messageFrame"><h1 class="mtableheader"> Messages</h1></div>
              </td>
            </tr>
          </table>
          
          <div id="loadingOverlay"
               style="  display: none;
                   position: fixed;
                   top: 0;
                   left: 0;
                   width: 100%;
                   <!--
                   height: 100%;
                   -->
                   height: 600px;
                   background-color: rgba(128, 128, 128, 0.8);
                   color: white;
                   font-size: 24px;
                   align-items: center;
                   justify-content: center;
                   z-index: 1000;">
            Searching messages... Mouse Click to stop.
          </div>
          
        </div>
        
        <div id="dlgError" class="dlgFrame">
          <div class="dlgTitlebar">Error message</div>
          <div class="dlgPanel">
            <div id="dlgErrorText">Dialog Contents</div>
            <br />
            <button class="dlgButton" onClick="dlgHide('dlgError')">Close</button>
          </div>
        </div>
        
        <script src="mu2e_messages.js"></script>

<!--    ------------------------- this is the old output window
     <div id="myDIV">
     <div id="content"> 
     </div>
     </div>
-->
      </div>
      
    </div>
    
  </body>
</html>
<!--
     emacs
     Local Variables:
     mode: web
     End:
-->
