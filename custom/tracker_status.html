<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link   rel="stylesheet" href="midas.css">
  <link   rel="stylesheet" href="tracker_style.css">
  <link   rel="stylesheet" href="mu2edaq.css">
  
  <script src="controls.js"></script>
  <script src="midas.js"></script>
  <script src="mhttpd.js"></script>
  <script src="filesrw.js"></script>

  <script srs="global_variables.js"></script>
  <script src="mu2edaq.js"></script>
  <script src="tracker_commands.js"></script>
  
  <title>Tracker Status</title>

  <script>
//-----------------------------------------------------------------------------
// main function
//-----------------------------------------------------------------------------
    async function createPage() {
    
      const urlParams    = new URLSearchParams(window.location.search);
      const stationIndex = urlParams.get('station') || '0';  // Default to Station_00
      const planeIndex   = urlParams.get('plane'  ) || '0';  // Default to Plane_00
      const npanels      = 6; // Number of panels


      const com_table       = document.getElementById('station_commands');
//      const com_table_title = document.querySelector("#table-title");
//      com_table_title.textContent = `Station ${stationIndex}`;

      const tracker_path  = `/Mu2e/ActiveRunConfiguration/Tracker`;
      const station_path  = `${tracker_path}/Station_${stationIndex.padStart(2,'0')}`;
//      x             = `<div class="modbvalue" data-odb-path="${tracker_path}/FirstStation">`;
//      const first_station = parseInt(`<div class="modbvalue" data-odb-path="${tracker_path}/FirstStation">`);
//      const last_station  = parseInt(`<div class="modbvalue" data-odb-path="${tracker_path}/LastStation">`);

        com_table.innerHTML = `
        <thead>
          <tr>
            <td>
              <div class="mtableheader">Tracker Status</div>
            </td>
            <td> station select:</td>
            <td colspan=12>
              <div class="tab">
                <button class="trk_station_tabs" id='st_00' onclick="choose_station_id(event,'st_00')">ST_00</button>
                <button class="trk_station_tabs" id='st_01' onclick="choose_station_id(event,'st_01')">ST_01</button>
                <button class="trk_station_tabs" id='st_02' onclick="choose_station_id(event,'st_02')">ST_02</button>
                <button class="trk_station_tabs" id='st_03' onclick="choose_station_id(event,'st_03')">ST_03</button>
                <button class="trk_station_tabs" id='st_04' onclick="choose_station_id(event,'st_04')">ST_04</button>
                <button class="trk_station_tabs" id='st_05' onclick="choose_station_id(event,'st_05')">ST_05</button>
                <button class="trk_station_tabs" id='st_05' onclick="choose_station_id(event,'st_05')">ST_05</button>
                <button class="trk_station_tabs" id='st_06' onclick="choose_station_id(event,'st_06')">ST_06</button>
                <button class="trk_station_tabs" id='st_07' onclick="choose_station_id(event,'st_07')">ST_07</button>
                <button class="trk_station_tabs" id='st_08' onclick="choose_station_id(event,'st_08')">ST_08</button>
                <button class="trk_station_tabs" id='st_09' onclick="choose_station_id(event,'st_09')">ST_09</button>
                <button class="trk_station_tabs" id='st_10' onclick="choose_station_id(event,'st_10')">ST_10</button>
                <button class="trk_station_tabs" id='st_11' onclick="choose_station_id(event,'st_11')">ST_11</button>
                <button class="trk_station_tabs" id='st_12' onclick="choose_station_id(event,'st_12')">ST_12</button>
                <button class="trk_station_tabs" id='st_13' onclick="choose_station_id(event,'st_13')">ST_13</button>
                <button class="trk_station_tabs" id='st_14' onclick="choose_station_id(event,'st_14')">ST_14</button>
                <button class="trk_station_tabs" id='st_15' onclick="choose_station_id(event,'st_15')">ST_15</button>
                <button class="trk_station_tabs" id='st_15' onclick="choose_station_id(event,'st_15')">ST_15</button>
                <button class="trk_station_tabs" id='st_16' onclick="choose_station_id(event,'st_16')">ST_16</button>
                <button class="trk_station_tabs" id='st_17' onclick="choose_station_id(event,'st_17')">ST_17</button>
                <button class="trk_station_tabs" id='st_18' onclick="choose_station_id(event,'st_18')"> ALL </button>
              </div>
            </td>
          </tr>
        </thead>
        <tbody></tbody>`;
      
      const com_table_tbody = com_table.querySelector("tbody");
//-----------------------------------------------------------------------------
// first row - commands
//-----------------------------------------------------------------------------
//      const r1  = document.createElement("tr");
//      const c2  = document.createElement("td");
//      c2.innerHTML = `
//               <input type=button value='load thresholds'   onClick='dtc_command("load_thresholds")'>
//               <input type=button value='load channel map'  onClick='dtc_command("load_channels_map")'>
//               <input type=button value='initialize'        onClick='dtc_command("initialize_tracker")'>
//               <input type=button value='reset_station_lv'  onClick='dtc_command("reset_station_lv")'>`;
//    
//      c2.colSpan = 6;
//      r1.appendChild(c2);
//      com_table_tbody.appendChild(r1);
//------------------------------------------------------------------------------
// next : read a station range and create one row per station
//-----------------------------------------------------------------------------
      let first_station = -1;
      let last_station  = -1;
      const p1 = tracker_path+`/FirstStation`;
      const p2 = tracker_path+`/LastStation`;
      mjsonrpc_db_get_values([p1, p2]).then(function (rpc) {
        first_station = parseInt(rpc.result.data[0]);
        last_station  = parseInt(rpc.result.data[1]);

        for (let i=first_station; i<last_station+1; i++) {
          const row       = document.createElement("tr");
        
          const s_path = `${tracker_path}/Station_${i.toString().padStart(2,'0')}`;
          const cell   = document.createElement("td");
          cell.innerHTML = `<b>Z-station ${i}</b>`;
          set_colors(s_path,cell);
          row.appendChild(cell);

          const plane_cell_done = new Array(2);
          for (let k=0; k<2; k++) { 
            plane_cell_done[k] = 0;
        
            // now - panels
            for (let ip=0; ip<6; ip++) {
              const panel_odb_path = s_path+`/Plane_${k.toString().padStart(2,'0')}`+`/Panel_${ip.toString().padStart(2,'0')}`;
            
              const c1     = document.createElement("td");
              c1.className = "status-cell";
              const mnid_path = panel_odb_path+`/Name`;
              mjsonrpc_db_get_values([mnid_path]).then(function (rpc) {
                const panel_name = rpc.result.data[0];
                const mnid = parseInt(panel_name.substring(2));
                c1.innerHTML = `<button onclick="trk_panel_control('${i}','${k}', '${ip}', '${mnid}')"> ${panel_name} </button></div>`;
            
                // Load initial values and set up polling for updates

                // Initial load
                set_colors(panel_odb_path,c1);

              // Poll for updates
                setInterval(() => {set_colors(panel_odb_path,c1);},2000);

                row.appendChild(c1);
              });
            }
          }
          com_table_tbody.appendChild(row);
        }
      });
    }
    document.addEventListener("DOMContentLoaded", createPage);
    </script>
</head>

<!--- ---------------------------------------------------------------------------
    BODY: tables
----------------------------------------------------------------------------- -->   

<body class="mcss" onload="mhttpd_init('Tracker Planes');">
   <div id="mheader"></div>
   <div id="msidenav"></div>

   
   <div id="mmain">

     <h1 id="table-title"></h1>
     <table class="mtable" id="station_commands">  <!-- Table content is generated dynamically -->
     </table>
     
   </div>


</body>
</html>

<!--
    emacs
    Local Variables:
    mode: web
    End:
  -->
