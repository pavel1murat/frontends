<!DOCTYPE html>
<html lang="en">
<head>
  <meta   charset="UTF-8">
  
  <link   rel="stylesheet" href="midas.css">
  <link   rel="stylesheet" href="mu2edaq.css">

  <script src="controls.js"></script>
  <script src="midas.js"></script>
  <script src="mhttpd.js"></script>
  <script src="filesrw.js"></script>
  <script src="odbbrowser.js"></script>
  <script src="mu2edaq.js"></script>
    
  <title>node_status</title>
    
  <script>
//-----------------------------------------------------------------------------
// the hostname (nodename) should be the same within the scope of this script
//-----------------------------------------------------------------------------
    let g_hostname = 'undefined';
//    let g_pcie     = 0;
//    let g_roc      = 0;
//-----------------------------------------------------------------------------
// CFO frontend : the name shoudl be fixed! 
//-----------------------------------------------------------------------------
//     function cfo_command(cmd) {
//       let msg = { "client_name":"cfo_emu_fe", "cmd":cmd, "args":'{}'};
//       mjsonrpc_call("jrpc",msg).then(function(rpc1) {
//         let s = rpc1.result.reply;
//         const regex = /\n/gi
//         let y = s.replaceAll(regex,'<br>');
//         
//         const el = document.getElementById("content");
//         el.innerHTML += y;
//         el.style.fontFamily = 'monospace';
//         el.scrollIntoView({ behavior: 'smooth', block: 'end' });
//         
//       }).catch(function(error){
//         mjsonrpc_error_alert(error);
//       });
//     }
// 
// //-----------------------------------------------------------------------------
//     function dtc_load_control_roc_read_parameters() {
//       const table     = document.getElementById('cmd_params');
//       table.innerHTML = '';
//       odb_browser('cmd_params','/Mu2e/Commands/Tracker/DTC/control_ROC_read',0);
//       //        window.location.href = `dtc_control_roc_read.html?hostname=${g_hostname}&pcie=${g_pcie}`;
//     }
//       
// //-----------------------------------------------------------------------------
//     function dtc_load_control_roc_digi_rw_parameters() {
//       const table     = document.getElementById('cmd_params');
//       table.innerHTML = '';
//       odb_browser('cmd_params','/Mu2e/Commands/Tracker/DTC/control_ROC_digi_rw',0);
//       //        window.location.href = `dtc_control_roc_read.html?hostname=${g_hostname}&pcie=${g_pcie}`;
//     }
// //-----------------------------------------------------------------------------
// 
//-----------------------------------------------------------------------------
//     function dtc_command(cmd) {
//       let msg = { "client_name":g_hostname, "cmd":cmd, "max_reply_length":10000,
//                   "args":'{"pcie":'+g_pcie.toString()+',"roc":'+g_roc.toString()+'}'};
//       mjsonrpc_call("jrpc",msg).then(function(rpc1) {
//         let s = rpc1.result.reply
//         console.log(s.length);
//         let y = '<br>'+s.replaceAll(/\n/gi,'<br>').replace(/ /g, '&nbsp;');
//         
//         const el = document.getElementById("content");
//         el.innerHTML += y;
//         el.style.fontFamily = 'monospace';
//         // el.scrollIntoView();
//         const scrollToBottom = (id) => {
//           el.scrollTop = el.scrollHeight;
//         }
//         
//       }).catch(function(error){
//         mjsonrpc_error_alert(error);
//       });
//     }
// //-----------------------------------------------------------------------------      
//     function choose_dtc_id(evt, dtc_id) {
//       var i, tablinks;
//       tablinks = document.getElementsByClassName("tablinks");
//       for (i=0; i<tablinks.length; i++) {
//         tablinks[i].className = tablinks[i].className.replace(" active", "");
//       }
//       document.getElementById(dtc_id).style.display = "block";
//       evt.currentTarget.className += " active";
//       
//       if (dtc_id == 'dtc0') { g_pcie = 0; } else {g_pcie = 1;} ;
//       console.log('g_pcie=',g_pcie);
//     }
// //-----------------------------------------------------------------------------      
//     function choose_roc_id(evt, roc_id) {
//       var i, roctabs;
//       roctabs = document.getElementsByClassName("roctabs");
//       for (i=0; i<roctabs.length; i++) {
//         roctabs[i].className = roctabs[i].className.replace(" active", "");
//       }
//       document.getElementById(roc_id).style.display = "block";
//       evt.currentTarget.className += " active";
//       
//       g_roc = Number(roc_id.charAt(3));
//       // -1: all ROCs
//       if (g_roc == 6) {g_roc = -1};
//       console.log('g_roc=',g_roc);
//     }
//-----------------------------------------------------------------------------
// main function defining the page contents
//-----------------------------------------------------------------------------
    function loadPage() {
      const urlParams = new URLSearchParams(window.location.search);
      g_hostname      = urlParams.get('hostname') || 'none';  // 
      document.title  = g_hostname;  // + ' status'
      
//      let title       = document.getElementById('table-title');
//      title.innerHTML = '&nbsp;&nbsp;&nbsp;'+g_hostname+' status page';
//-----------------------------------------------------------------------------
//  fill ARTDAQ commands table
//-----------------------------------------------------------------------------
      const artdaq_table     = document.getElementById('artdaq_table');
      artdaq_table.innerHTML = `<tbody></tbody>`;
      const tbody            = artdaq_table.querySelector('tbody');
      const row1             = document.createElement("tr");
      const td1              = document.createElement('td');
      td1.innerHTML          = `<div class="mtableheader"> ${g_hostname} controls </div>`
      td1.colspan            = 2;

      td2                    = document.createElement('td');
      td2.colSpan            = 4;
//------------------------------------------------------------------------------
// add a tab per process
//-----------------------------------------------------------------------------
      div1 = document.createElement("div");
      div1.class = "tab";
      const processes_path   = '/Mu2e/ActiveRunConfiguration/DAQ/Nodes/'+g_hostname+'/Artdaq';
      mjsonrpc_db_get_values([processes_path]).then(function (rpc) {
        let nodesp  = rpc.result.data[0];
        let keys    = Object.keys(nodesp);
        let values  = Object.values(nodesp);
        let entries = Object.entries(nodesp);
        
        nkeys = keys.length;
        for (let i = 1; i < nkeys; i+=2) {
          let key = keys[i];
          if (key.toUpperCase().startsWith("ENABLED") || key.toUpperCase().startsWith("STATUS")) { continue; }
          const btn = document.createElement("button");
          btn.setAttribute("class","artdaq_process_tabs");
          btn_id = i.toString().padStart(2, "0")
          btn.setAttribute("id"   ,btn_id);
          btn.setAttribute("onclick","choose_artdaq_process_id(event,btn_id)");
          btn.innerHTML = key; // key: 'br01' etc
          div1.appendChild(btn);
        };
      });
      
      td2.appendChild(div1);
      
      row1.appendChild(td1);
      row1.appendChild(td2);
      
      tbody.appendChild(row1);
      
      tbody.insertAdjacentHTML("beforeend",`
        <tr>
          <td colspan=2>

            <div class="dropup">
              <input type=button class="dropbtn" value='process status'>
              <div class="dropup-content">
                <div onClick='tfm_load_parameters_process_status()' > Load Parameters </div>
                <div onClick='tfm_command_set_odb("process_status")'> Run             </div>
              </div>
            </div>

          </td>
        </tr>
      `);
//-----------------------------------------------------------------------------
//  fill node parameters table
//-----------------------------------------------------------------------------
      const node_table     = document.getElementById('node_table');
      node_table.innerHTML = '';
      odb_browser('node_table',`/Mu2e/ActiveRunConfiguration/DAQ/Nodes/${g_hostname}`,0);
//-----------------------------------------------------------------------------
// end of loadPage
//-----------------------------------------------------------------------------
    }
//-----------------------------------------------------------------------------
// loadPage is the function doing the job
//-----------------------------------------------------------------------------
  document.addEventListener("DOMContentLoaded", loadPage);
  </script>
  </head>
<!-- ------------------------------------------------------------------------------
     here the HTML structure starts
     it seems to be convenient to have the large scale topology in HtML and use
     javascript to fill hte details
     her is the high-level structure of the page - menus on hte left, output window - on the right
  ------------------------------------------------------------------------------  -->
  <body class="mcss" onload="mhttpd_init('${g_hostname} status');">
    <div id="mheader"></div>
    <div id="msidenav"></div>
    <div id="mmain">
<!-- ---------------- row 1: ----------------  -->
      
      <div class="row">
     <!--   <h3 id="table-title">Node name... </h3>  -->
        
        <div class="column"> <!-- column gets pushed to the left -->

          <table class="mtable" id="artdaq_table">  <!-- Table content is generated dynamically -->
          </table>
          
          <table class="mtable" id="node_table">    <!-- Table content is generated dynamically -->
          </table>
          
        </div>
<!--    ------------------------- this is the output window  -->
        <div id="myDIV">
          <div id="content"> 
          </div>
        </div>

      </div>

    </div>

  </body>
</html>
<!--
    emacs
    Local Variables:
    mode: web
    End:
  -->
