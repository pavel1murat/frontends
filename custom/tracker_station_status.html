<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <link rel="stylesheet" href="midas.css">
   <link rel="stylesheet" href="tracker_style.css">
   <script src="controls.js"></script>
   <script src="midas.js"></script>
   <script src="mhttpd.js"></script>
   <script src="filesrw.js"></script>
    <link   rel="stylesheet" href="mu2edaq.css">

    <title>Tracker AAAA</title>

   <script>
     function load_values(path, statusCell) {
       // Fetch values for Enabled and Status
       const path_enabled = path+`/Enabled`;
       const path_status  = path+`/Status`;
       mjsonrpc_db_get_values([path_enabled, path_status]).then(function (rpc) {
         let enabled = rpc.result.data[0];
         let status = rpc.result.data[1];

         // Apply color styles
         if (enabled === 0) {
           statusCell.style.backgroundColor = "gray";
           statusCell.style.color = "white";
         } else if (enabled === 1) {
           if (status === 0) {
             statusCell.style.backgroundColor = "green";
             statusCell.style.color = "white";
           } else if (status < 0) {
             statusCell.style.backgroundColor = "red";
             statusCell.style.color = "white";
           } else if (status > 0) {
             statusCell.style.backgroundColor = "yellow";
             statusCell.style.color = "black";
           }
         } else {
           statusCell.style.backgroundColor = "white";
           statusCell.style.color = "white";
         }
       }).catch(function (error) {
         console.error("Error fetching values:", error);
       });
     }

//-----------------------------------------------------------------------------
// main function
//-----------------------------------------------------------------------------
     function createPage() {
       const urlParams    = new URLSearchParams(window.location.search);
       const stationIndex = urlParams.get('station') || '0';  // Default to Station_00
       const planeIndex   = urlParams.get('plane'  ) || '0';  // Default to Plane_00
       const npanels      = 6; // Number of panels


     const com_table     = document.getElementById('station_commands');

        com_table.innerHTML = `
        <thead>
          <tr>
            <td colspan=15> <div class="mtableheader">Tracker Control Commands </div></td>
          </tr>
        </thead>

        <tbody>                                                                        
           <tr>
             <td> <div class="tab"> Station 0</div> </td>
             <td> <div class="tab"> plane 25 </div> </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel00" onclick="choose_dtc_id(event,'panel00')">MN261</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel01" onclick="choose_dtc_id(event,'panel01')">MN248</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel02" onclick="choose_dtc_id(event,'panel02')">MN224</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel03" onclick="choose_dtc_id(event,'panel03')">MN262</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel04" onclick="choose_dtc_id(event,'panel04')">MN273</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel05" onclick="choose_dtc_id(event,'panel05')">MN276</button>
            </td>
             <td> <div class="tab"> plane 21 </div> </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel06" onclick="choose_dtc_id(event,'panel06')">MN253</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel07" onclick="choose_dtc_id(event,'panel07')">MN101</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel08" onclick="choose_dtc_id(event,'panel08')">MN219</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel09" onclick="choose_dtc_id(event,'panel09')">MN213</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel10" onclick="choose_dtc_id(event,'panel10')">MN235</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel11" onclick="choose_dtc_id(event,'panel11')">MN247</button>
              </div>
            </td>
          </tr>
<!-
 Station 2-
-->
           <tr>
             <td> <div class="tab"> Station 1</div> </td>
             <td> <div class="tab"> plane X1 </div> </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel00" onclick="choose_dtc_id(event,'panel00')">MN261</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel01" onclick="choose_dtc_id(event,'panel01')">MN248</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel02" onclick="choose_dtc_id(event,'panel02')">MN224</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel03" onclick="choose_dtc_id(event,'panel03')">MN262</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel04" onclick="choose_dtc_id(event,'panel04')">MN273</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel05" onclick="choose_dtc_id(event,'panel05')">MN276</button>
            </td>
             <td> <div class="tab"> plane Y1 </div> </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel06" onclick="choose_dtc_id(event,'panel06')">MN253</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel07" onclick="choose_dtc_id(event,'panel07')">MN101</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel08" onclick="choose_dtc_id(event,'panel08')">MN219</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel09" onclick="choose_dtc_id(event,'panel09')">MN213</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel10" onclick="choose_dtc_id(event,'panel10')">MN235</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel11" onclick="choose_dtc_id(event,'panel11')">MN247</button>
              </div>
            </td>
          </tr>
<!-
 Station 2-
-->
           <tr>
             <td> <div class="tab"> Station 2</div> </td>
             <td> <div class="tab"> plane X2 </div> </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel00" onclick="choose_dtc_id(event,'panel00')">MN261</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel01" onclick="choose_dtc_id(event,'panel01')">MN248</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel02" onclick="choose_dtc_id(event,'panel02')">MN224</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel03" onclick="choose_dtc_id(event,'panel03')">MN262</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel04" onclick="choose_dtc_id(event,'panel04')">MN273</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel05" onclick="choose_dtc_id(event,'panel05')">MN276</button>
            </td>
             <td> <div class="tab"> plane Y2 </div> </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel06" onclick="choose_dtc_id(event,'panel06')">MN253</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel07" onclick="choose_dtc_id(event,'panel07')">MN101</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel08" onclick="choose_dtc_id(event,'panel08')">MN219</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel09" onclick="choose_dtc_id(event,'panel09')">MN213</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel10" onclick="choose_dtc_id(event,'panel10')">MN235</button>
            </td>
            <td> <div class="tab">
                <button class="tablinks" id="panel11" onclick="choose_dtc_id(event,'panel11')">MN247</button>
              </div>
            </td>
          </tr>

          <tr>
            <td colspan=15>
              <input type=button value='load thresholds'   onClick='dtc_command("load_thresholds")'>
              <input type=button value='load bad channels' onClick='dtc_command("load_bad_channels")'>
              <input type=button value='initialize'        onClick='dtc_command("initialize_tracker")'>
            </td>
          </tr>
       </tbody>`;




//       const table = document.querySelector(".mtable");
       const table = document.getElementById('planes_table');

       // Set the table title dynamically
       const title = document.querySelector("#table-title");
       title.textContent = `Station ${stationIndex}`;

       // Clear existing table rows
       table.innerHTML = `
            <thead>
               <tr>
                  <th>Panel</th>
                  <th>Plane 0</th>
                  <th>Plane 1</th>
               </tr>
            </thead>
            <tbody></tbody>
         `;

       const tbody = table.querySelector("tbody");
       
       const station_path   = `/Mu2e/ActiveRunConfiguration/Tracker/Station_${stationIndex.padStart(2,'0')}`;

       for (let i = 0; i < npanels; i++) {
         const row = document.createElement("tr");

         // panel Cell
         const panelCell = document.createElement("td");
         panelCell.innerHTML = `<b>Panel ${i}</b>`;
         row.appendChild(panelCell);
//-----------------------------------------------------------------------------
// two columns coresponding to to planes
//-----------------------------------------------------------------------------
         for (let ip=0; ip<2; ip++) {
           const cell = document.createElement("td");
           cell.className = "status-cell";
           cell.innerHTML = `<button onclick="redirectToPanels('${stationIndex}','${ip}', '${i}')">view panel</button>`;

           // Load initial values and set up polling for updates
         
           const path     = station_path+`/Plane_${ip.toString().padStart(2,'0')}`+`/Panel_${i.toString().padStart(2,'0')}`;

           // Initial load
           load_values(path,cell);

           // Poll for updates
           setInterval(() => {load_values(path,cell);},2000);

           row.appendChild(cell);
         }

         tbody.appendChild(row);
       }
     }

     function redirectToPanels(is, iplane, ipanel) {
       window.location.href = `tracker_panel_status.html?station=${is}&plane=${iplane}&panel=${ipanel}`;
     }

     document.addEventListener("DOMContentLoaded", createPage);
   </script>
</head>

<!--- ---------------------------------------------------------------------------
    BODY: tables
----------------------------------------------------------------------------- -->   

<body class="mcss" onload="mhttpd_init('Tracker Planes');">
   <div id="mheader"></div>
   <div id="msidenav"></div>

   
   <div id="mmain">

     <table class="mtable" id="station_commands">  <!-- Table content is generated dynamically -->
     </table>
     
      <h1 id="table-title">Planes</h1>
      <table class="mtable" id="planes_table">
         <!-- Table content is generated dynamically -->
      </table>
   </div>


</body>
</html>

<!--
    emacs
    Local Variables:
    tab-width: 8
    c-basic-offset: 2
    js-indent-level: 0
    indent-tabs-mode: nil
    End:
  -->
